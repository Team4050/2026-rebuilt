# AGENTS.md

This file provides guidance to Claude Code (claude.ai/code) and other AI Agents when working with code in this repository.

## Build

```bash
./gradlew build              # Compile + spotless format check
./gradlew simulateJava       # Run WPILib simulation with GUI
./gradlew spotlessApply      # Auto-format code (Palantir Java Format)
```

Spotless runs automatically before compilation. A git pre-commit hook is installed via `installGitHook`.

## Architecture

This is an FRC (FIRST Robotics Competition) Java project using WPILib's command-based framework. Team 4050, 2026 season.

**Robot lifecycle**: `Main` → `Robot` (TimedRobot) → `RobotContainer` (subsystems + bindings) → `RobotState` (telemetry + shared state)

### Subsystems

Subsystems live in `src/main/java/frc/robot/subsystems/`. Each extends `SubsystemBase` (or implements `Subsystem`) and encapsulates hardware (motors, sensors) behind public action methods. The `periodic()` method runs every cycle for housekeeping like odometry. Default commands are set in `RobotContainer` to define idle behavior. Subsystem instances are created as fields in `RobotContainer`.

### Commands

Commands are the unit of robot action. This project primarily uses inline/lambda commands via `RunCommand`, `Commands.defer()`, and subsystem factory methods (e.g., `drivetrain.applyRequest()`). Custom command classes, when needed, go in `src/main/java/frc/robot/commands/` and extend `Command`, implementing `initialize()`, `execute()`, `end(interrupted)`, and `isFinished()`. Commands declare subsystem requirements via `addRequirements()`. Bindings between triggers (buttons, mode changes) and commands are configured in `RobotContainer.configureBindings()`.

### RobotState (Singleton)

Central hub for cross-cutting state and telemetry. Subsystems register themselves (e.g., `addDrivetrain()`). Access anywhere with `RobotState.getInstance()`. Contains match period logic (alliance shifts, scoring period tracking) and publishes SmartDashboard widgets (Field2d, swerve visualization).

### Telemetry

- **Epilogue** (`@Logged` annotations): Primary telemetry path. Class-level `@Logged` with `USE_HUMAN_NAME` naming logs all fields; use `@NotLogged` to exclude. Minimum importance is `DEBUG`.
- **SmartDashboard**: Used only for types Epilogue can't handle: `Field2d`, `SendableChooser`, swerve drive widget (Elastic format), `CommandScheduler`.
- **DataLogManager**: Mirrors all NetworkTables to `.wpilog` on disk.
- **Elastic dashboard**: Layout in `src/main/deploy/dashboard.json`, served via `WebServer.start(5800, ...)`.

### Swerve Drive

Two-file architecture built on CTRE Phoenix 6:

- **`TunerConstants.java`** (generated by CTRE Tuner X, then customized): Hardware config for the swerve builder — motor types, sensor types, PID gains, gear ratios, module positions, and CAN IDs. Defines `TunerSwerveDrivetrain` inner class extending `SwerveDrivetrain<TalonFX, TalonFX, CANcoder>`. Factory method `createDrivetrain()` instantiates modules. Uses TorqueCurrentFOC for both steer and drive closed-loop control, FusedCANcoder for steer feedback, and Pigeon2 for gyro.
- **`Drivetrain.java`** (subsystem): Extends `TunerSwerveDrivetrain`, implements `Subsystem`. Adds command-based integration (`applyRequest()`), SysId characterization routines (translation/steer/rotation with dashboard chooser), operator perspective handling (auto-sets forward direction based on alliance color), and vision measurement overrides that convert FPGA timestamps. Simulation runs a 4ms update loop via `Notifier`.

## Key Conventions

- **CAN IDs**: Drivetrain modules use `<module 1-4><device 1-3>` scheme (e.g., 11=FL drive, 12=FL steer, 13=FL encoder). Other subsystems in 50s range. Defined in `Constants.java`.
- **CANivore bus**: Named `"Drivetrain"` for all swerve devices.
- **Generated code**: `TunerConstants.java` (CTRE Tuner X output) and `BuildConstants.java` (GVersion git metadata). Do not edit directly.
- **Third-party libraries**: Managed as vendordep JSON files in `vendordeps/`. Each file declares Maven coordinates, JNI bindings, and version info for a vendor library. Must match the WPILib year.

## 2026 Game Mechanics

Teleop has alternating alliance scoring shifts (4 shifts of 25s each, starting at 130s remaining). `RobotState` tracks which shift is active and whether it's our scoring period via game-specific message data from the FMS.

## Documentation

Prefer online JavaDoc documentation over dumping individual dependency Jar files or inefficient searches. Some useful documentation sources:

- WPILib: https://github.wpilib.org/allwpilib/docs/release/java/index.html
- CTRE/Phoenix: https://api.ctr-electronics.com/phoenix6/stable/java/
- RevRobotics: https://codedocs.revrobotics.com/java/

